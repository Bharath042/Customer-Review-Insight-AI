{% extends "base_user_dashboard.html" %}

{% block title %}Dashboard | ReviewSense AI{% endblock %}

{% block content %}
    <header class="header"><h1>Welcome, {{ username }}</h1></header>

    <section class="stat-cards">
        <div class="card"><h3>Total Reviews</h3><p class="stat-number">{{ stats.total_reviews }}</p></div>
        <div class="card"><h3>Positive Sentiment</h3><p class="stat-number">{{ stats.positive_percentage }}%</p></div>
        <div class="card"><h3>Negative Sentiment</h3><p class="stat-number">{{ stats.negative_percentage }}%</p></div>
        <div class="card"><h3>Neutral Sentiment</h3><p class="stat-number">{{ stats.neutral_percentage }}%</p></div>
    </section>

    <div class="dashboard-grid">
        <div class="side-panel">
            <section class="table-container card">
                <h2>My Recent Reviews</h2>
                <table>
                    <thead><tr><th>Review</th><th>Sentiment</th></tr></thead>
                    <tbody>
                        {% for review in recent_reviews %}
                        <tr>
                            <td>{{ review.content | truncate(50) }}</td>
                            <td>
                                {% set sentiment = review.sentiment.strip().upper() if review.sentiment else "NEUTRAL" %}
                                {% if sentiment == "POSITIVE" %}
                                    <span class="sentiment-label positive">Positive</span>
                                {% elif sentiment == "NEGATIVE" %}
                                    <span class="sentiment-label negative">Negative</span>
                                {% else %}
                                    <span class="sentiment-label neutral">Neutral</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="2" style="text-align: center;">You havenâ€™t submitted any reviews yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
        </div>

        <div class="main-panel">
            <section class="card">
                <h2>My Sentiment Distribution</h2>
                <div style="max-height: 250px; display: flex; justify-content: center; align-items: center;">
                    <canvas id="userSentimentChart"></canvas>
                </div>
            </section>
        </div>
    </div>
{% endblock %}

{% block scripts %} {# Add the Chart.js script to the scripts block #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('userSentimentChart').getContext('2d');
            const chartData = {{ chart_data | tojson }};
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        label: 'My Sentiment Distribution',
                        data: [chartData.positive, chartData.negative, chartData.neutral],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(108, 117, 125, 0.8)'
                        ],
                        borderColor: ['#161b22','#161b22','#161b22'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e6edf3',
                                font: { family: "'Poppins', sans-serif" },
                                padding: 34
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}