{% extends 'admin_base.html' %}

{% block title %}Manage Aspect Categories - Admin{% endblock %}
{% block header_title %}Manage Aspect Categories{% endblock %}

{% block head_extra %}
<style>
    /* Custom styles for aspect categories page */
    .aspect-entry {
        transition: all 0.3s ease;
    }
    .aspect-entry:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .form-label.fw-bold {
        font-size: 0.9rem;
        color: #495057;
    }
    .card-header.bg-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    .card-header.bg-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    }
    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }
    .table th {
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .btn-outline-primary:hover, .btn-outline-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    small.text-muted {
        font-size: 0.8rem;
    }
    
    /* Professional Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.active {
        display: flex;
    }
    .modal-content {
        background-color: var(--bg-light);
        border-radius: 12px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    .modal-header {
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
    }
    .modal-header h3 {
        margin: 0;
        color: var(--text-primary);
        font-family: 'Poppins', sans-serif;
    }
    .modal-body {
        margin-bottom: 20px;
    }
    .modal-body .form-group {
        margin-bottom: 15px;
    }
    .modal-body label {
        display: block;
        margin-bottom: 5px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    .modal-body input,
    .modal-body textarea {
        width: 100%;
        padding: 10px;
        background-color: var(--bg-dark);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-family: 'Poppins', sans-serif;
    }
    .modal-body textarea {
        resize: vertical;
        min-height: 60px;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .modal-footer button {
        padding: 8px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
    }
    .btn-cancel {
        background-color: var(--bg-dark);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    .btn-save {
        background-color: var(--accent-blue);
        color: white;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid py-4">

    {# Card for Adding New Aspect Category with Aspects - HIDDEN, using modal instead #}
    <div class="card mb-4 shadow-sm" style="display: none;">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-plus-circle"></i> Add New Category with Aspects</h4>
        </div>
        <div class="card-body p-4">
            <form action="{{ url_for('admin_dashboard.manage_aspect_categories') }}" method="POST" id="categoryForm">
                <!-- Category Information Section -->
                <div class="bg-light p-3 rounded mb-4">
                    <h5 class="mb-3"><i class="fas fa-tag"></i> Category Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category_name" class="form-label fw-bold">Category Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg" id="category_name" name="category_name" required placeholder="e.g., Electronics, Food, Hotels">
                            <small class="text-muted">Choose a broad category name</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category_description" class="form-label fw-bold">Category Description</label>
                            <textarea class="form-control" id="category_description" name="category_description" rows="3" placeholder="Brief description of this category"></textarea>
                            <small class="text-muted">Optional: Explain what this category covers</small>
                        </div>
                    </div>
                </div>
                
                <!-- Aspects Section -->
                <div class="mb-4">
                    <h5 class="mb-2"><i class="fas fa-list-ul"></i> Aspects for this Category</h5>
                    <p class="text-muted">Add specific aspects that will be analyzed in customer reviews (e.g., Camera, Battery, Service Quality)</p>
                    
                    <div id="aspectsContainer">
                        <!-- Dynamic aspect entries will be added here -->
                        <div class="aspect-entry card mb-3 border-primary" data-aspect-index="0" style="border-left: 4px solid #0d6efd;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0 text-primary"><i class="fas fa-cube"></i> Aspect #1</h6>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAspect(0)" disabled>
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Aspect Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="aspects[0][name]" required placeholder="e.g., Camera">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Description</label>
                                        <input type="text" class="form-control" name="aspects[0][description]" placeholder="What this aspect covers">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Weightage (1-5) <span class="text-danger">*</span></label>
                                        <input type="number" step="0.1" min="1" max="5" class="form-control" name="aspects[0][weightage]" required value="3">
                                        <small class="text-muted">Importance: 5=Critical, 1=Minor</small>
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label fw-bold">Keywords (comma-separated) <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="aspects[0][keywords]" required placeholder="photo, camera, image, picture, lens">
                                        <small class="text-muted">Words/phrases to match in reviews</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary" onclick="addAspect()">
                        <i class="fas fa-plus"></i> Add Another Aspect
                    </button>
                </div>
                
                <hr class="my-4">
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="reset" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-undo"></i> Reset Form
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="fas fa-save"></i> Create Category with Aspects
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let aspectIndex = 1;
        
        function addAspect() {
            const container = document.getElementById('aspectsContainer');
            const newAspect = `
                <div class="aspect-entry card mb-3 border-primary" data-aspect-index="${aspectIndex}" style="border-left: 4px solid #0d6efd;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 text-primary"><i class="fas fa-cube"></i> Aspect #${aspectIndex + 1}</h6>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAspect(${aspectIndex})">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Aspect Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="aspects[${aspectIndex}][name]" required placeholder="e.g., Battery">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Description</label>
                                <input type="text" class="form-control" name="aspects[${aspectIndex}][description]" placeholder="What this aspect covers">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Weightage (1-5) <span class="text-danger">*</span></label>
                                <input type="number" step="0.1" min="1" max="5" class="form-control" name="aspects[${aspectIndex}][weightage]" required value="3">
                                <small class="text-muted">Importance: 5=Critical, 1=Minor</small>
                            </div>
                            <div class="col-md-9">
                                <label class="form-label fw-bold">Keywords (comma-separated) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="aspects[${aspectIndex}][keywords]" required placeholder="battery, charge, power, drain">
                                <small class="text-muted">Words/phrases to match in reviews</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newAspect);
            aspectIndex++;
        }
        
        function removeAspect(index) {
            const aspectEntry = document.querySelector(`[data-aspect-index="${index}"]`);
            if (aspectEntry) {
                aspectEntry.remove();
            }
        }
    </script>

    {# Card for Existing Categories and Nested Aspects/Keywords #}
    <div class="card shadow-sm">
        <div class="card-header" style="background-color: var(--bg-light); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h4 class="mb-0" style="color: var(--text-primary); font-family: 'Poppins', sans-serif;">Categories & Aspects</h4>
            <button onclick="showAddCategoryModal()" class="btn btn-sm" style="background-color: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500;">
                <i class="fas fa-plus"></i> Add Category
            </button>
        </div>
        <div class="card-body p-4" style="background-color: var(--bg-dark);">
            <!-- Search Box -->
            <div class="mb-4">
                <input type="text" id="searchBox" class="form-control" placeholder="ðŸ” Search" 
                       style="background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px 15px;">
            </div>
            
            {% if categories %}
                <div class="accordion" id="categoriesAccordion">
                {% for category in categories %}
                    <div class="accordion-item category-item" style="background-color: var(--bg-light); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px;">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" 
                                    style="background-color: var(--bg-light); color: var(--text-primary); border: none; padding: 15px 20px; font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-chevron-down me-2" style="transition: transform 0.3s;"></i>
                                <strong>{{ category.name }}</strong>
                                {% if category.description %}
                                    <span class="ms-2 text-muted" style="font-size: 0.9rem;">{{ category.description }}</span>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#categoriesAccordion">
                            <div class="accordion-body" style="background-color: var(--bg-dark); padding: 20px;">
                                <!-- Category Actions -->
                                <div class="d-flex justify-content-between mb-3">
                                    <button class="btn btn-sm" onclick="showAddAspectForm({{ category.id }})" style="background-color: var(--accent-blue); color: white; border: none; padding: 6px 12px; border-radius: 6px;">
                                        <i class="fas fa-plus"></i> Add Aspect
                                    </button>
                                    <div>
                                        <button class="btn btn-sm me-2" onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.description if category.description else '' }}')" style="background: none; border: 1px solid var(--border-color); color: var(--text-primary); padding: 6px 12px; border-radius: 6px;">
                                            <i class="fas fa-edit"></i> Edit Category
                                        </button>
                                        <button class="btn btn-sm" onclick="deleteCategory({{ category.id }})" 
                                                style="background-color: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px;">
                                            <i class="fas fa-trash"></i> Delete Category
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Add Aspect Form (Initially Hidden) -->
                                <div id="addAspectForm{{ category.id }}" style="display: none; background-color: var(--bg-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <h6 style="color: var(--text-primary); margin-bottom: 10px;">Add New Aspect</h6>
                                    <form action="{{ url_for('admin_dashboard.add_aspect_to_category', category_id=category.id) }}" method="POST">
                                        <div class="row g-2">
                                            <div class="col-md-3">
                                                <input type="text" name="aspect_name" class="form-control form-control-sm" placeholder="Aspect Name" required 
                                                       style="background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary);">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" name="aspect_description" class="form-control form-control-sm" placeholder="Description (optional)" 
                                                       style="background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary);">
                                            </div>
                                            <div class="col-md-2">
                                                <input type="number" step="0.1" min="1" max="5" name="weightage" class="form-control form-control-sm" placeholder="Weight" value="3" required 
                                                       style="background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary);">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" name="keywords" class="form-control form-control-sm" placeholder="Keywords (comma-separated)" 
                                                       style="background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary);">
                                            </div>
                                            <div class="col-md-1">
                                                <button type="submit" class="btn btn-sm btn-success w-100">Add</button>
                                                <button type="button" onclick="hideAddAspectForm({{ category.id }})" class="btn btn-sm btn-secondary w-100 mt-1">Cancel</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Aspects List -->
                        {% if category.aspects %}
                            {% for aspect in category.aspects %}
                                <div class="aspect-card mb-3" style="background-color: var(--bg-light); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 style="color: var(--text-primary); font-family: 'Poppins', sans-serif; margin-bottom: 5px;">
                                                {{ aspect.name }}
                                            </h6>
                                            {% if aspect.description %}
                                                <p class="text-muted mb-2" style="font-size: 0.85rem;">{{ aspect.description }}</p>
                                            {% endif %}
                                            <div class="keywords-container">
                                                {% if aspect.keywords %}
                                                    {% for kw in aspect.keywords %}
                                                        <span class="keyword-badge" style="background-color: var(--bg-dark); color: var(--text-secondary); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; display: inline-block; margin-bottom: 5px;">{{ kw.keyword }}</span>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="aspect-actions" style="display: flex; gap: 10px;">
                                            <button class="btn btn-sm" onclick='editAspect({{ aspect.id }}, "{{ aspect.name }}", "{{ aspect.description if aspect.description else "" }}", {{ aspect.weightage }}, "{% if aspect.keywords %}{% for kw in aspect.keywords %}{{ kw.keyword }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}")' style="background: none; border: none; color: var(--text-secondary); cursor: pointer;" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm" onclick="deleteAspect({{ aspect.id }})" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-info-circle"></i> No aspects added yet.
                            </div>
                        {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5" style="color: var(--text-secondary);">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <h5>No Categories Yet</h5>
                    <p>Start by creating your first category using the form above.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="editCategoryModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Category</h3>
        </div>
        <form id="editCategoryForm" method="POST">
            <div class="modal-body">
                <div class="form-group">
                    <label for="editCategoryName">Category Name *</label>
                    <input type="text" id="editCategoryName" name="category_name" required>
                </div>
                <div class="form-group">
                    <label for="editCategoryDesc">Description</label>
                    <textarea id="editCategoryDesc" name="category_description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('editCategoryModal')">Cancel</button>
                <button type="submit" class="btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Aspect Modal -->
<div id="editAspectModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Aspect</h3>
        </div>
        <form id="editAspectForm" method="POST">
            <div class="modal-body">
                <div class="form-group">
                    <label for="editAspectName">Aspect Name *</label>
                    <input type="text" id="editAspectName" name="aspect_name" required>
                </div>
                <div class="form-group">
                    <label for="editAspectDesc">Description</label>
                    <input type="text" id="editAspectDesc" name="aspect_description">
                </div>
                <div class="form-group">
                    <label for="editAspectWeight">Weightage (1-5) *</label>
                    <input type="number" id="editAspectWeight" name="weightage" min="1" max="5" step="0.1" required>
                </div>
                <div class="form-group">
                    <label for="editAspectKeywords">Keywords (comma-separated) *</label>
                    <textarea id="editAspectKeywords" name="keywords" placeholder="camera, photo, image"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('editAspectModal')">Cancel</button>
                <button type="submit" class="btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>Add New Category with Aspects</h3>
        </div>
        <form action="{{ url_for('admin_dashboard.manage_aspect_categories') }}" method="POST" id="addCategoryForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCategoryName">Category Name *</label>
                    <input type="text" id="newCategoryName" name="category_name" required placeholder="e.g., Electronics, Food, Hotels">
                </div>
                <div class="form-group">
                    <label for="newCategoryDesc">Description</label>
                    <textarea id="newCategoryDesc" name="category_description" placeholder="Brief description of this category"></textarea>
                </div>
                
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">Aspects for this Category</label>
                    <div id="modalAspectsContainer">
                        <!-- First aspect -->
                        <div class="modal-aspect-entry" data-modal-aspect-index="0" style="background-color: var(--bg-dark); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--accent-blue);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: var(--text-primary);">Aspect #1</strong>
                                <button type="button" class="btn btn-sm" onclick="removeModalAspect(0)" disabled style="background: none; border: none; color: var(--text-secondary); cursor: not-allowed;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <input type="text" name="aspects[0][name]" class="form-control" placeholder="Aspect Name *" required style="margin-bottom: 8px; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px; width: 100%;">
                            <input type="text" name="aspects[0][description]" class="form-control" placeholder="Description (optional)" style="margin-bottom: 8px; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px; width: 100%;">
                            <div style="display: flex; gap: 10px;">
                                <input type="number" step="0.1" min="1" max="5" name="aspects[0][weightage]" class="form-control" placeholder="Weight (1-5)" value="3" required style="flex: 1; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                                <input type="text" name="aspects[0][keywords]" class="form-control" placeholder="Keywords (comma-separated) *" required style="flex: 2; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addModalAspect()" class="btn btn-sm" style="background-color: var(--bg-light); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 6px; margin-top: 10px;">
                        <i class="fas fa-plus"></i> Add Another Aspect
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('addCategoryModal')">Cancel</button>
                <button type="submit" class="btn-save">Create Category with Aspects</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Container for notifications -->
<div class="toast-container" id="toastContainer"></div>

<script>
function deleteCategory(categoryId) {
    if (confirm('Are you sure you want to delete this category and all its aspects?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/aspect_categories/delete/${categoryId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function showAddAspectForm(categoryId) {
    document.getElementById('addAspectForm' + categoryId).style.display = 'block';
}

function hideAddAspectForm(categoryId) {
    document.getElementById('addAspectForm' + categoryId).style.display = 'none';
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-icon">
            ${type === 'success' ? 
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>' :
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" /></svg>'
            }
        </div>
        <p class="toast-message">${message}</p>
    `;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('fade-out');
        toast.addEventListener('animationend', () => toast.remove());
    }, 3000);
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

let modalAspectIndex = 1;

function showAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.add('active');
}

function addModalAspect() {
    const container = document.getElementById('modalAspectsContainer');
    const newAspect = `
        <div class="modal-aspect-entry" data-modal-aspect-index="${modalAspectIndex}" style="background-color: var(--bg-dark); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--accent-blue);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="color: var(--text-primary);">Aspect #${modalAspectIndex + 1}</strong>
                <button type="button" class="btn btn-sm" onclick="removeModalAspect(${modalAspectIndex})" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <input type="text" name="aspects[${modalAspectIndex}][name]" class="form-control" placeholder="Aspect Name *" required style="margin-bottom: 8px; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px; width: 100%;">
            <input type="text" name="aspects[${modalAspectIndex}][description]" class="form-control" placeholder="Description (optional)" style="margin-bottom: 8px; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px; width: 100%;">
            <div style="display: flex; gap: 10px;">
                <input type="number" step="0.1" min="1" max="5" name="aspects[${modalAspectIndex}][weightage]" class="form-control" placeholder="Weight (1-5)" value="3" required style="flex: 1; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                <input type="text" name="aspects[${modalAspectIndex}][keywords]" class="form-control" placeholder="Keywords (comma-separated) *" required style="flex: 2; background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 4px;">
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', newAspect);
    modalAspectIndex++;
}

function removeModalAspect(index) {
    const aspectEntry = document.querySelector(`[data-modal-aspect-index="${index}"]`);
    if (aspectEntry) {
        aspectEntry.remove();
    }
}

function editCategory(categoryId, categoryName, categoryDescription) {
    document.getElementById('editCategoryName').value = categoryName;
    document.getElementById('editCategoryDesc').value = categoryDescription;
    document.getElementById('editCategoryForm').action = `/admin/category/${categoryId}/edit`;
    document.getElementById('editCategoryModal').classList.add('active');
}

function editAspect(aspectId, aspectName, aspectDesc, weightage, keywords) {
    document.getElementById('editAspectName').value = aspectName;
    document.getElementById('editAspectDesc').value = aspectDesc;
    document.getElementById('editAspectWeight').value = weightage;
    document.getElementById('editAspectKeywords').value = keywords;
    document.getElementById('editAspectForm').action = `/admin/aspect/${aspectId}/edit`;
    document.getElementById('editAspectModal').classList.add('active');
}

function deleteAspect(aspectId) {
    if (confirm('Are you sure you want to delete this aspect?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/aspect/${aspectId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Search functionality
document.getElementById('searchBox').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const categoryItems = document.querySelectorAll('.category-item');
    
    categoryItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Rotate chevron on accordion toggle
document.querySelectorAll('.accordion-button').forEach(button => {
    button.addEventListener('click', function() {
        const icon = this.querySelector('.fa-chevron-down');
        if (this.classList.contains('collapsed')) {
            icon.style.transform = 'rotate(0deg)';
        } else {
            icon.style.transform = 'rotate(180deg)';
        }
    });
});

// Close modal when clicking outside
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
});

// Show toast for Flask flash messages
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            showToast('{{ message }}', '{{ category }}');
        {% endfor %}
    {% endif %}
{% endwith %}
</script>
{% endblock %}
